<tal:block i18n:domain="collecting_society_portal_repertoire"
           tal:define="oid oid|field.oid;
                       name field.name;
                       title title|field.title;
                       actions dumps(field.schema.actions)
                              |dumps(field.widget.actions)
                              |'';
                       min_len min_len|field.schema.min_len
                                      |field.widget.min_len
                                      |0;
                       max_len max_len|field.schema.max_len
                                      |field.widget.max_len
                                      |100000;
                       now_len len(subfields);
                       orderable orderable|field.schema.orderable
                                          |field.widget.orderable
                                          |0;
                       prototype field.widget.prototype(field);
                       errormsg field.errormsg">

    <!-- sequence -->
    <div class="datatable_sequence_${oid}"
         data-data="${data}" data-language="${language}"></div>

    <!-- slot: settings -->
    <script metal:define-slot="settings" />

    <script>
      datatableSequenceSettings = $.extend(true, {
        oid: "${oid}",
        name: "${name}",
        title: "${title}",
        actions: '${actions}',
        minLen: "${min_len}",
        maxLen: "${max_len}",
        orderable: "${orderable}",
        proto: "${prototype}",
        errormsg: "${errormsg}",
        api: "${api}",
      }, datatableSequenceSettings);
    </script>

    <!-- slot: init -->
    <script metal:define-slot="init">
      new deform.DatatableSequence(datatableSequenceSettings).init();
    </script>

    <!-- slot: template sequence -->
    <script metal:define-slot="tpl_sequence" type="text/x-tmpl"
            id="datatable_sequence_${oid}_tpl_sequence">
      <div class="form-group {%=(o.errormsg?'has-error':'')%} item-{%=o.ds.name%}">
        {% if (o.ds.title) { %}
          <label class="control-label {%=o.lableClass%}" for="{%=o.ds.name%}">
            {%=o.ds.title%}
          </label>
        {% } %}

        {% include( o.ds.tpl.controls,
                    { add: true,
                      create: true,
                      ds: o.ds }); %}
      
        {% include( o.ds.tpl.target.table,
                    { ds: o.ds }); %}

        {% if (o.ds.actions.indexOf('add') != -1) { %}
          {% include( o.ds.tpl.modal,
                      { role: 'add',
                        title: o.ds.language.custom.add,
                        content: o.ds.tpl.source.table,
                        pin: true,
                        ds: o.ds }); %}
        {% } %}

        {% if (o.ds.actions.indexOf('create') != -1) { %}
          {% include( o.ds.tpl.modal,
                      { role: 'create',
                        title: o.ds.language.custom.create,
                        content: o.ds.tpl.create,
                        ds: o.ds }); %}
        {% } %}
        
        {% if (o.ds.actions.indexOf('edit') != -1) { %}
          {% include( o.ds.tpl.modal,
                      { role: 'edit',
                        title: o.ds.language.custom.edit,
                        content: o.ds.tpl.edit,
                        ds: o.ds }); %}
        {% } %}

        {% if (o.errormsg) { %}
            <p class="help-block" id="error-{%=o.ds.oid%}">
              {%=o.errormsg%}
            </p>
        {% } %}    
      </div>
    </script>

    <!-- slot: template controls -->
    <script metal:define-slot="tpl_controls" type="text/x-tmpl"
            id="datatable_sequence_${oid}_tpl_controls">
      <div class="btn-group cs-datatables-controls {%=o.ds.sel.base%}_controls"
           role="group" aria-label="SequenceControls">
        {% if (o.add && o.ds.actions.indexOf('add') != -1) { %}
          <button type="button" class="btn btn-default"
                  data-toggle="modal" data-target="{%=o.ds.sel.modalAdd%}">
            {%=o.ds.language.custom.add%}
          </button>
        {% } %}
        {% if (o.create && o.ds.actions.indexOf('create') != -1) { %}
          <button type="button" class="btn btn-default"
                  data-toggle="modal" data-target="{%=o.ds.sel.modalCreate%}">
            {%=o.ds.language.custom.create%}
          </button>
        {% } %}
      </div>
    </script>

    <!-- slot: template target table -->
    <script metal:define-slot="tpl_target" type="text/x-tmpl"
            id="datatable_sequence_${oid}_tpl_target">
      <div class="{%=o.ds.sel.base%}_target_area">
        <input type="hidden" name="__start__" value="{%=o.ds.name%}:sequence" />
        <table id="{%=o.ds.sel.base%}_target"
               class="table table-hover cs-datatables"></table>
        <input type="hidden" name="__end__" value="{%=o.ds.name%}:sequence" />
      </div>
    </script>

    <!-- slot: template source table -->
    <script metal:define-slot="tpl_source" type="text/x-tmpl"
            id="datatable_sequence_${oid}_tpl_source">
      <div class="{%=o.ds.sel.base%}_source_area">
          <table id="{%=o.ds.sel.base%}_source"
                 class="table table-hover responsive cs-datatables">
            <tfoot>
              <tr>
                {% for (var i=0; i<o.ds.source.columns.length; i++) { %}
                  {% if (o.ds.source.columns[i].datatableSequence
                         && o.ds.source.columns[i]
                            .datatableSequence.footerSearch) { %}
                    <th class="multifilter"> 
                      <input type="text"
                             placeholder="{%=o.ds.language.custom.search%} {%=o.ds.source.columns[i].title%}" />
                    </th>
                  {% } else { %}
                    <th></th>
                  {% } %}
                {% } %}
              </tr>
            </tfoot>
          </table>
      </div>
    </script>

    <!-- slot: template modal -->
    <script metal:define-slot="tpl_modal" type="text/x-tmpl"
            id="datatable_sequence_${oid}_tpl_modal">
      <div class="modal fade cs-modal" id="{%=o.ds.sel.base%}_modal_{%=o.role%}" 
           aria-labelledby="{%=o.ds.sel.base%}_modal_{%=o.role%}_header"
           tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg" role="document">
          <div class="modal-content">
            <div class="modal-header cs-modal-header">
              <button type="button" class="close"
                      data-dismiss="modal" aria-label="Close">
                <span class="glyphicon glyphicon-remove"></span>
              </button>
              {% if (o.pin) { %}
                <button type="button" class="close pin" aria-label="Pin"
                        onclick="return {%=o.ds.registry%}.pinModal(this);">
                  <span class="glyphicon glyphicon-pushpin"></span>
                </button>
              {% } %}
              {% if (o.title) { %}
                <h4 id="{%=o.ds.sel.base%}_modal_{%=o.role%}_header"
                    class="modal-title">
                  {%=o.title%}
                </h4>
              {% } %}
            </div>
            <div class="modal-body">
              {% include(o.content, o); %}
            </div>
            {% if (o.footer) { %}
              <div class="modal-body">
                {% include(o.footer, o); %}
              </div>
            {% } %}
          </div>
        </div>
      </div>
    </script>

    <!-- slot: template create -->
    <script metal:define-slot="tpl_create" type="text/x-tmpl"
            id="datatable_sequence_${oid}_tpl_create">
      {%#o.ds.sequence%}
      <div class="btn-group" role="group">
        <a href="#" class="btn btn-default cs-datatables-apply" role="button"
           onclick="return {%=o.ds.registry%}.createRow(this);">
          {%=o.ds.language.custom.apply%}
        </a>
        <a href="#" class="btn btn-default" role="button"
           data-dismiss="modal" aria-label="Close">
          {%=o.ds.language.custom.cancel%}
        </a>
      </div>
    </script>

    <!-- slot: template edit -->
    <script metal:define-slot="tpl_edit" type="text/x-tmpl"
            id="datatable_sequence_${oid}_tpl_edit">
      <input name="index" type="hidden" value="">
      <div class='deform-sequence-item'></div>
      <div class="btn-group" role="group">
        <a href="#" class="btn btn-default cs-datatables-apply" role="button"
           onclick="return {%=o.ds.registry%}.saveRow(this);">
          {%=o.ds.language.custom.apply%}
        </a>
        <a href="#" class="btn btn-default" role="button"
           data-dismiss="modal" aria-label="Close">
          {%=o.ds.language.custom.cancel%}
        </a>
      </div>
    </script>

    <!-- slot: template target column controls -->
    <script metal:define-slot="tpl_target_controls" type="text/x-tmpl"
            id="datatable_sequence_${oid}_tpl_target_controls">
      <div class="btn-group-vertical cs-row-controls" role="group">
        {% if (o.data.mode !== "add" && o.actions.indexOf('edit') != -1) { %}
          <a href="#" role="button" onclick="return {%=o.registry%}.editRow(this);"
             class="btn btn-sm {%=o.editClass%} cs-datatables-row-edit">
              {%=o.language.custom.edit%}
          </a>
        {% } %}
        <a href="#" role="button" onclick="return {%=o.registry%}.removeRow(this);"
           class="btn btn-default btn-sm cs-datatables-row-remove">
            {%=o.language.custom.remove%}
        </a>
      </div>
    </script>

    <!-- slot: template target column show -->
    <script metal:define-slot="tpl_target_show" type="text/x-tmpl"
            id="datatable_sequence_${oid}_tpl_target_show">
      <table>
        {% for (var i=0; i<o.columns.length; i++) { %}
          {% if (o.row[o.columns[i].name]) { %}
              <tr>
                <td class="cs-datatables-row-show">
                  <small>{%=o.columns[i].title%}</small>
                </td>
                <td class="fullwidth">
                  {%=o.row[o.columns[i].name]%}
                </td>
              </tr>
          {% } %}
        {% } %}
        {% if (o.row.errors) { %}
          <tr>
            <td colspan="2">
              {%#o.row.errors%}
            </td>
          </tr>
        {% } %}
      </table>
    </script>

    <!-- slot: template source column controls -->
    <script metal:define-slot="tpl_source_controls" type="text/x-tmpl"
            id="datatable_sequence_${oid}_tpl_source_controls">
      <div class="btn-group-vertical cs-row-controls" role="group">
        {% if (o.added) { %}
          <a href="#" role="button" class="btn btn-default btn-sm"
             onclick="return {%=o.registry%}.removeRow({%=o.added.index()%});">
              {%=o.language.custom.remove%}
          </a>
        {% } else { %}
          <a href="#" role="button" class="btn btn-default btn-sm"
             onclick="return {%=o.registry%}.addRow({%=o.meta.row%});">
              {%=o.language.custom.add%}
          </a>
        {% } %}
      </div>
    </script>

    <!-- slot: template target and source column more -->
    <script metal:define-slot="tpl_more" type="text/x-tmpl"
            id="datatable_sequence_${oid}_tpl_more">
      {% if (o.data.mode === "create") { %}
        <i><small>{%=o.language.custom.new%}</small></i>
      {% } else { %}
        {% if (o.hidden) { %}
          <span class="more">
            <span class="glyphicon glyphicon-zoom-in"></span>
          </span>
        {% } %}
      {% } %}
    </script>

    <!-- slot: template target and source details -->
    <script metal:define-slot="tpl_details" type="text/x-tmpl"
            id="datatable_sequence_${oid}_tpl_details">
      <table class="table cs-datatables-row-details">
        {% for (var i=0; i<o.columns.length; i++) { %}
          {% if (o.columns[i].data && o.columns[i].hidden) { %}
              <tr>
                <td>
                  <small>{%=o.columns[i].title%}<small>
                </td>
                <td class="fullwidth">
                  {%=o.columns[i].data%}
                </td>
              </tr>
          {% } %}
        {% } %}
      </table>
    </script>

</tal:block>